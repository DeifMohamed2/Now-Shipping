<%- contentFor('HeaderCss') %>
<link href="/assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
<style>
  .smart-flyer-card {
    border-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    transition: all .3s ease;
  }
  .smart-flyer-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  .btn-primary-custom {
    background: #F39720;
    border-color: #F39720;
    color: #fff;
  }
  .btn-primary-custom:hover {
    background: #E58809;
    border-color: #E58809;
  }
  .preview-container {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 2rem;
    min-height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .flyer-preview {
    background: #f8f9fa;
    border: none;
    border-radius: 0;
    padding: 5px;
    text-align: center;
    width: 283px;  /* 100mm in pixels at 72 DPI */
    height: 142px; /* 50mm in pixels at 72 DPI */
    position: relative;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
  }
  .preview-content-area {
    background: white;
    border: 1px solid #000;
    width: calc(100% - 10px);
    height: calc(100% - 10px);
    padding: 2px;
    box-sizing: border-box;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .preview-logo-icon {
    position: absolute;
    top: 7px;
    left: 50%;
    transform: translateX(-50%);
    width: 42px;
    height: 42px;
    object-fit: contain;
  }
  .barcode-preview {
    margin-top: 50px;
    max-width: 165px;
    width: 165px;
    height: auto;
    margin-left: auto;
    margin-right: auto;
  }
  .loading-spinner {
    display: none;
  }
  .loading-spinner.active {
    display: block;
  }
</style>

<%- contentFor('body') %>


<div class="row">
  <div class="col-xl-6">
    <div class="card smart-flyer-card">
      <div class="card-header">
        <h4 class="card-title mb-0">Generate Smart Flyers</h4>
      </div>
      <div class="card-body">
        <form id="generateFlyersForm">
          <div class="mb-4">
            <label for="flyerAmount" class="form-label">Number of Flyers</label>
            <input 
              type="number" 
              class="form-control form-control-lg" 
              id="flyerAmount" 
              placeholder="Enter number of flyers (e.g., 100)" 
              min="1" 
              max="1000"
              required
            >
            <div class="form-text">Maximum 1000 flyers per batch</div>
          </div>

          <div class="mb-4">
            <label for="startingNumber" class="form-label">Starting Barcode Number (Optional)</label>
            <input 
              type="text" 
              class="form-control" 
              id="startingNumber" 
              placeholder="Leave empty to auto-generate" 
              maxlength="14"
            >
            <div class="form-text">14-digit barcode number. Leave empty to auto-generate sequential numbers.</div>
          </div>


          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary-custom btn-lg">
              <i class="ri-printer-line align-middle me-2"></i>
              Generate PDF
            </button>
            <button type="button" class="btn btn-outline-secondary" id="previewBtn">
              <i class="ri-eye-line align-middle me-2"></i>
              Preview Single Flyer
            </button>
          </div>
        </form>

        <div class="loading-spinner text-center mt-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Generating...</span>
          </div>
          <p class="mt-3 text-muted">Generating smart flyers PDF... Please wait</p>
        </div>
      </div>
    </div>

    <!-- Info Card -->
    <div class="card smart-flyer-card mt-4">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="ri-information-line text-primary me-2"></i>
          About Smart Flyers
        </h5>
        <p class="text-muted mb-2">
          Smart flyers are printed cards with unique barcodes that can be used for:
        </p>
        <ul class="text-muted">
          <li>Quick order tracking and identification</li>
          <li>Automated order processing</li>
          <li>Inventory management</li>
          <li>Customer delivery verification</li>
        </ul>
        <div class="alert alert-info mb-2">
          <i class="ri-information-line me-2"></i>
          <strong>Label Size:</strong> 100mm Ã— 50mm (landscape label)
        </div>
        <div class="alert alert-warning mb-0">
          <i class="ri-alert-line me-2"></i>
          Each barcode is unique and will be 14 digits long for optimal scanning.
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-6">
    <div class="card smart-flyer-card">
      <div class="card-header">
        <h4 class="card-title mb-0">Preview</h4>
      </div>
      <div class="card-body">
        <div class="preview-container">
          <div class="flyer-preview" id="flyerPreview">
            <div class="preview-content-area">
              <img id="previewLogo" src="/logo.png" alt="Company Logo" class="preview-logo-icon">
              <div class="barcode-preview">
                <svg id="barcodePreview"></svg>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Generated Flyers -->
    <div class="card smart-flyer-card mt-4">
      <div class="card-header">
        <h4 class="card-title mb-0">Recent Generations</h4>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Range</th>
              </tr>
            </thead>
            <tbody id="recentGenerations">
              <tr>
                <td colspan="3" class="text-center text-muted py-3">
                  No recent generations
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<%- contentFor('FooterJs') %>
<script src="/assets/libs/sweetalert2/sweetalert2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('generateFlyersForm');
  const previewBtn = document.getElementById('previewBtn');
  const loadingSpinner = document.querySelector('.loading-spinner');
  const flyerAmountInput = document.getElementById('flyerAmount');
  const startingNumberInput = document.getElementById('startingNumber');

  // Load recent generations from localStorage
  loadRecentGenerations();

  // Preview button handler
  previewBtn.addEventListener('click', function() {
    const amount = flyerAmountInput.value || 1;
    const startingNum = startingNumberInput.value;
    generatePreview(startingNum);
  });

  // Form submit handler
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const amount = parseInt(flyerAmountInput.value);
    const startingNum = startingNumberInput.value;

    if (!amount || amount < 1 || amount > 1000) {
      Swal.fire({
        icon: 'error',
        title: 'Invalid Amount',
        text: 'Please enter a number between 1 and 1000'
      });
      return;
    }

    // Show confirmation
    const result = await Swal.fire({
      title: 'Generate Smart Flyers?',
      html: `You are about to generate <strong>${amount}</strong> smart flyers.<br>This may take a few moments.`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Generate PDF',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#F39720'
    });

    if (!result.isConfirmed) return;

    // Show loading
    loadingSpinner.classList.add('active');
    form.style.display = 'none';

    try {
      const response = await fetch('/admin/generate-smart-flyers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          amount: amount,
          startingNumber: startingNum
        })
      });

      if (response.ok && response.headers.get('content-type')?.includes('application/pdf')) {
        // The PDF is being downloaded directly via the response stream
        // Create a blob and trigger download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `smart-flyers-${Date.now()}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Calculate barcode range for display
        const startNum = startingNum || generateBarcode();
        const endNum = (BigInt(startNum) + BigInt(amount) - 1n).toString().padStart(14, '0');
        const barcodeRange = `${startNum} - ${endNum}`;
        
        // Save to recent generations
        saveToRecentGenerations(amount, barcodeRange);
        
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: `Generated ${amount} smart flyers successfully! PDF download started.`,
          confirmButtonColor: '#F39720'
        });

        // Reset form
        form.reset();
      } else {
        // Handle error response
        const errorText = await response.text();
        let errorMessage = 'Failed to generate flyers';
        try {
          const errorData = JSON.parse(errorText);
          errorMessage = errorData.message || errorMessage;
        } catch (e) {
          errorMessage = errorText || errorMessage;
        }
        throw new Error(errorMessage);
      }
    } catch (error) {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Generation Failed',
        text: error.message || 'An error occurred while generating the flyers'
      });
    } finally {
      loadingSpinner.classList.remove('active');
      form.style.display = 'block';
    }
  });

  // Generate preview
  function generatePreview(startingNum) {
    let barcodeNum;
    
    if (startingNum && startingNum.length === 14) {
      barcodeNum = startingNum;
    } else {
      // Generate random 14-digit number
      barcodeNum = generateBarcode();
    }

    // Generate barcode only (no text, no logo) - bigger by 10% and centered
    try {
      JsBarcode("#barcodePreview", barcodeNum, {
        format: "CODE128",
        width: 1.65,  // Increased by 10% (1.5 * 1.1)
        height: 44,  // Increased by 10% (40 * 1.1)
        displayValue: false,  // No text display
        fontSize: 10,
        margin: 2
      });
    } catch (err) {
      console.error('Barcode generation error:', err);
    }
  }

  // Generate 14-digit barcode (never starts with 0)
  function generateBarcode() {
    // Generate first digit (1-9, never 0)
    const firstDigit = Math.floor(Math.random() * 9) + 1; // Random 1-9
    // Generate remaining 13 digits
    const remainingDigits = Math.floor(Math.random() * 10000000000000); // Random 13 digits
    const barcode = firstDigit.toString() + remainingDigits.toString().padStart(13, '0');
    
    return barcode;
  }

  // Save to recent generations (localStorage)
  function saveToRecentGenerations(amount, range) {
    let recent = JSON.parse(localStorage.getItem('recentFlyerGenerations') || '[]');
    recent.unshift({
      date: new Date().toISOString(),
      amount: amount,
      range: range
    });
    // Keep only last 10
    recent = recent.slice(0, 10);
    localStorage.setItem('recentFlyerGenerations', JSON.stringify(recent));
    loadRecentGenerations();
  }

  // Load recent generations from localStorage
  function loadRecentGenerations() {
    const recent = JSON.parse(localStorage.getItem('recentFlyerGenerations') || '[]');
    const tbody = document.getElementById('recentGenerations');
    
    if (recent.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No recent generations</td></tr>';
      return;
    }

    tbody.innerHTML = recent.map(gen => {
      const date = new Date(gen.date);
      return `
        <tr>
          <td>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>
          <td><span class="badge bg-primary">${gen.amount}</span></td>
          <td class="small">${gen.range}</td>
        </tr>
      `;
    }).join('');
  }

  // Generate initial preview
  setTimeout(() => generatePreview(), 500);
});
</script>

