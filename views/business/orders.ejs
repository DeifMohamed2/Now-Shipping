<%- contentFor('HeaderCss') %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.6/lottie.min.js"></script>

<link href="/assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/status-styles.css" rel="stylesheet" type="text/css" />
<link href="/assets/libs/flatpickr/flatpickr.min.css" rel="stylesheet" type="text/css" />
<%- contentFor('body') %>

<style>
  /* Professional Dropdown Styles */
  .orders-table-dropdown {
    position: relative;
    display: inline-block;
    z-index: 1;
  }

  .orders-table-dropdown.show {
    z-index: 1060 !important;
    position: relative;
  }

  .orders-table-dropdown .dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    left: auto;
    z-index: 1060 !important;
    min-width: 220px;
    padding: 0.5rem 0;
    margin: 0.25rem 0 0 0;
    font-size: 0.875rem;
    color: #212529;
    text-align: left;
    list-style: none;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
    display: none;
  }

  .orders-table-dropdown.show .dropdown-menu {
    display: block !important;
    z-index: 1060 !important;
    position: absolute !important;
  }

  .orders-table-dropdown .dropdown-item {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 0.65rem 1.25rem;
    clear: both;
    font-weight: 400;
    font-size: 0.875rem;
    color: #495057;
    text-align: inherit;
    text-decoration: none;
    white-space: nowrap;
    background-color: transparent;
    border: 0;
    transition: all 0.15s ease-in-out;
    cursor: pointer;
  }

  .orders-table-dropdown .dropdown-item:hover,
  .orders-table-dropdown .dropdown-item:focus {
    color: #212529;
    background-color: #f8f9fa;
  }

  .orders-table-dropdown .dropdown-item i {
    width: 20px;
    margin-right: 0.75rem;
    text-align: center;
    font-size: 0.95rem;
  }

  .orders-table-dropdown .dropdown-toggle {
    background: transparent;
    border: none;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    transition: background-color 0.15s ease-in-out;
    cursor: pointer;
    color: #6c757d;
    font-size: 1.2rem;
    position: relative;
    z-index: 1;
  }

  .orders-table-dropdown .dropdown-toggle:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .orders-table-dropdown .dropdown-toggle:focus {
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  /* Table container adjustments */
  .table-responsive {
    overflow-x: auto;
    overflow-y: visible;
    position: relative;
  }

  /* Ensure dropdowns are visible */
  .card-body,
  .card {
    overflow: visible !important;
    position: relative;
  }
  
  /* Ensure card-body doesn't clip dropdowns */
  .card-body.pt-0 {
    overflow: visible !important;
  }
  
  /* Ensure the div containing nav-tabs doesn't interfere */
  .card-body > div {
    position: relative;
    overflow: visible;
  }

  /* Ensure table doesn't clip dropdowns */
  .table {
    position: relative;
    z-index: 1;
  }

  /* Ensure dropdown appears above table and other elements */
  .orders-table-dropdown.show .dropdown-menu {
    display: block !important;
    z-index: 1060 !important;
    position: absolute !important;
  }
  
  /* Ensure nav-tabs don't create stacking context issues */
  .nav-tabs {
    position: relative;
    z-index: 1;
  }
  
  .nav-tabs-custom {
    z-index: 1;
  }
  
  /* Ensure card-header doesn't interfere with dropdowns */
  .card-header {
    position: relative;
    z-index: 1;
  }
  
  /* Ensure the status category dropdown doesn't interfere */
  #statusCategoryDropdown,
  .dropdown-menu[aria-labelledby="statusCategoryDropdown"] {
    z-index: 1000;
  }
  
  /* Force dropdown menu to appear above all other elements */
  .orders-table-dropdown.show .dropdown-menu {
    z-index: 1060 !important;
    position: absolute !important;
    pointer-events: auto !important; /* Ensure clicks work */
  }
  
  /* Ensure dropdown items are clickable */
  .orders-table-dropdown .dropdown-item {
    pointer-events: auto !important;
    cursor: pointer !important;
    user-select: none; /* Prevent text selection on click */
  }
  
  /* Ensure dropdown toggle is clickable */
  .orders-table-dropdown .dropdown-toggle {
    pointer-events: auto !important;
    cursor: pointer !important;
  }
  
  /* Ensure dropdown menu list items are clickable */
  .orders-table-dropdown .dropdown-menu li {
    pointer-events: auto !important;
  }
  
  /* Ensure nav-tabs container doesn't block dropdowns */
  .nav-tabs-custom.nav-success {
    position: relative;
    z-index: 1;
  }
  
  /* Override any potential z-index from Bootstrap or other libraries */
  #orderTable .orders-table-dropdown.show .dropdown-menu {
    z-index: 1060 !important;
  }
  
  /* Ensure table cell with dropdown doesn't block interactions */
  #orderTable tbody td:last-child {
    position: relative;
  }
  
  #orderTable tbody td:last-child .orders-table-dropdown.show {
    z-index: 1060 !important;
  }
  
  /* Ensure table rows with dropdowns are in proper stacking context */
  #orderTable tbody tr {
    position: relative;
  }
  
  /* Ensure table cells with dropdowns have proper positioning */
  #orderTable tbody td:last-child {
    position: relative;
    z-index: auto;
  }
  
  #orderTable tbody td:last-child .orders-table-dropdown.show {
    z-index: 99999 !important;
  }
  
  /* Make sure the table container itself doesn't create issues */
  .table-responsive.table-card {
    position: relative;
    overflow: visible !important;
  }
  
  /* Ensure table doesn't clip dropdowns */
  #orderTable {
    position: relative;
  }
  
  #orderTable thead {
    position: relative;
    z-index: 1;
  }

  /* Special positioning for last row dropdowns */
  .orders-table-dropdown.dropdown-up .dropdown-menu {
    top: auto !important;
    bottom: 100% !important;
    margin-bottom: 5px;
    z-index: 1060 !important;
  }

  /* Mobile responsive adjustments */
  @media (max-width: 768px) {
    .orders-table-dropdown .dropdown-menu {
      right: 0;
      left: auto;
      min-width: 180px;
    }
  }

  /* Smart Sticker Modal Professional Styles */
  .bg-gradient-primary {
    background: linear-gradient(135deg, #fdb614 0%, #f39720 100%);
  }

  .scan-icon-wrapper {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .scan-icon {
    font-size: 1.5rem;
    color: white;
  }

  .scan-animation {
    position: relative;
    display: inline-block;
  }

  .scan-circle {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    animation: scanPulse 2s ease-in-out infinite;
  }

  .scan-circle i {
    font-size: 2rem;
    color: #fdb614;
  }

  .scan-circle::before {
    content: '';
    position: absolute;
    width: 90px;
    height: 90px;
    border: 2px solid #fdb614;
    border-radius: 50%;
    opacity: 0.3;
    animation: scanRing 2s ease-in-out infinite;
  }

  @keyframes scanPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  @keyframes scanRing {
    0% { transform: scale(0.8); opacity: 1; }
    100% { transform: scale(1.2); opacity: 0; }
  }

  .feature-card, .download-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .feature-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f8f9fa;
  }

  .feature-item:last-child {
    border-bottom: none;
  }

  .feature-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
  }

  .feature-icon i {
    font-size: 1.25rem;
  }

  .feature-text h6 {
    color: #495057;
    font-size: 0.9rem;
  }

  .feature-text p {
    font-size: 0.8rem;
    color: #6c757d;
  }

  .download-btn {
    border-radius: 10px;
    padding: 1rem 1.5rem;
    font-weight: 500;
    border: none;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .download-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }

  .download-btn:hover::before {
    left: 100%;
  }

  .download-text {
    text-align: left;
  }

  .download-label {
    font-size: 0.8rem;
    opacity: 0.9;
    margin-bottom: 2px;
  }

  .download-platform {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .steps-container {
    position: relative;
  }

  .step-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    position: relative;
  }

  .step-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 19px;
    top: 40px;
    width: 2px;
    height: calc(100% + 0.5rem);
    background: #e9ecef;
  }

  .step-indicator {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #fdb614 0%, #f39720 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }

  .step-number {
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .step-title {
    color: #495057;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .step-description {
    color: #6c757d;
    font-size: 0.85rem;
    margin: 0;
  }

  .modal-content {
    border-radius: 16px;
    overflow: hidden;
  }

  .modal-header {
    padding: 1.5rem 2rem;
  }

  .modal-footer {
    border-top: 1px solid #e9ecef;
  }

  .btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-primary {
    background: linear-gradient(135deg, #fdb614 0%, #f39720 100%);
    border: none;
    color: white;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #f39720 0%, #e8851a 100%);
    color: white;
  }

  /* Print Policy Modal Professional Styles */
  .print-icon-wrapper {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .print-icon {
    font-size: 1.5rem;
    color: white;
  }

  .bg-light-info {
    background-color: #e3f2fd !important;
  }

  .paper-size-card {
    background: #fff;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .paper-size-card:hover {
    border-color: #fdb614;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(253, 182, 20, 0.15);
  }

  .paper-size-card.selected {
    border-color: #fdb614;
    background: linear-gradient(135deg, #fff8e1 0%, #fff3c4 100%);
    box-shadow: 0 8px 25px rgba(253, 182, 20, 0.2);
  }

  .paper-icon-container {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .paper-icon {
    font-size: 1.75rem;
    color: #fdb614;
  }

  .paper-info {
    flex: 1;
  }

  .paper-label {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .paper-dimensions {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
  }

  .paper-description {
    color: #adb5bd;
    font-size: 0.8rem;
  }

  .selection-indicator {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 24px;
    height: 24px;
    background: #fdb614;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
  }

  .selection-indicator i {
    color: white;
    font-size: 0.75rem;
  }

  .paper-size-card.selected .selection-indicator {
    opacity: 1;
    transform: scale(1);
  }


  #printBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  #printBtn:disabled:hover {
    transform: none;
    box-shadow: none;
  }
</style>
<style>
  .paper-size-container {
    margin-bottom: 15px;
  }

  .paper-size-option {
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 15px 10px;
    border-radius: 8px;
    background-color: #f8f9fa;
    border: 2px solid transparent;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .paper-size-option:hover {
    transform: translateY(-3px);
    background-color: #e9ecef;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .paper-size-option.selected {
    background-color: rgba(13, 110, 253, 0.1);
    border-color: #0d6efd;
    color: #0d6efd;
  }

  .paper-icon {
    margin-bottom: 10px;
    position: relative;
  }

  .paper-icon i {
    font-size: 2.5rem;
    display: block;
    margin: 0 auto;
  }

  .size-label {
    font-weight: bold;
    font-size: 1.1rem;
    display: block;
    margin-top: 5px;
  }

  .paper-details {
    font-size: 0.8rem;
    color: #6c757d;
  }

</style>
<div class="row">
  <div class="col-lg-12">
    <div class="card" id="orderList">
      <div class="card-header border-0">
        <div class="row align-items-center gy-3">
          <div class="col-sm">
            <h5 class="card-title mb-0">Orders</h5>
          </div>
          <div class="col-sm-auto">
            <div class="d-flex gap-1 flex-wrap">
              <button type="button" class="btn btn-success add-btn" onClick='window.location.href="/business/create-order"'><i class="ri-add-line align-bottom me-1"></i> Create Order</button>
              <button type="button" class="btn btn-info" onclick="exportOrdersToExcel()"><i class="ri-file-download-line align-bottom me-1"></i> Export</button>
              <button class="btn btn-soft-danger" id="remove-actions" onClick="deleteMultiple()"><i class="ri-delete-bin-2-line"></i></button>
            </div>
          </div>
        </div>
      </div>
      <!-- Bulk Actions Toolbar -->
      <div class="card-header border-0 bg-light" id="bulkActionsToolbar" style="display: none;">
        <div class="row align-items-center">
          <div class="col-sm">
            <h6 class="mb-0">
              <i class="ri-checkbox-multiple-line me-1"></i>
              <span id="selectedCount">0</span> order(s) selected
            </h6>
          </div>
          <div class="col-sm-auto">
            <div class="d-flex gap-2 flex-wrap">
              <button type="button" class="btn btn-primary btn-sm" onclick="bulkPrintPolicy()">
                <i class="ri-printer-fill me-1"></i> Print Policies
              </button>
              <button type="button" class="btn btn-light btn-sm" onclick="clearSelection()">
                <i class="ri-close-line me-1"></i> Clear Selection
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body border border-dashed border-end-0 border-start-0">
        <form>
          <div class="row g-3">
            <div class="col-xxl-5 col-sm-6">
              <div class="search-box">
                <input type="text" class="form-control search" placeholder="Search for order ID, customer, order status or something...">
                <i class="ri-search-line search-icon"></i>
              </div>
            </div>
            <!--end col-->
            <div class="col-xxl-2 col-sm-6">
              <div>
                <input type="text" class="form-control" data-provider="flatpickr" data-date-format="d M, Y" data-range-date="true" id="demo-datepicker" placeholder="Select date">
              </div>
            </div>
            <!--end col-->
            <div class="col-xxl-2 col-sm-4">
              <div>
                <select class="form-control" data-choices data-choices-search-false name="choices-single-default" id="idStatus">
                  <option value="">Status</option>
                  <option value="all" selected>All</option>
                  <option value="waitingAction">Waiting Action</option>
                  <option value="rescheduled">Rescheduled</option>
                  <option value="new">New</option>
                  <option value="pickedUp">Picked Up</option>
                  <option value="inStock">In Stock</option>
                  <option value="inProgress">In Progress</option>
                  <option value="headingToCustomer">Heading To Customer</option>
                  <option value="headingToYou">Heading To You</option>
                  <option value="completed">Completed</option>
                  <option value="canceled">Canceled</option>
                  <option value="rejected">Rejected</option>
                  <option value="returned">Returned</option>
                  <option value="returnLinked">Return Linked</option>
                  <option value="returnToWarehouse">Return to Warehouse</option>
                  <option value="terminated">Terminated</option>
                </select>
              </div>
            </div>
            <!--end col-->
            <div class="col-xxl-2 col-sm-4">
              <div>
                <select class="form-control" data-choices data-choices-search-false name="choices-single-default" id="idPayment">
                  <option value="">Select Payment</option>
                  <option value="all" selected>All</option>
                  <option value="Mastercard">Mastercard</option>
                  <option value="Paypal">Paypal</option>
                  <option value="Visa">Visa</option>
                  <option value="COD">COD</option>
                </select>
              </div>
            </div>
            <!--end col-->
            <div class="col-xxl-1 col-sm-4">
              <div>
                <button type="button" class="btn btn-primary w-100" onclick="SearchData();"> <i class="ri-equalizer-fill me-1 align-bottom"></i>
                  Filters
                </button>
              </div>
            </div>
            <!--end col-->
          </div>
          <!--end row-->
        </form>
      </div>
      <div class="card-body pt-0">
        <div>
          <ul class="nav nav-tabs nav-tabs-custom nav-success mb-3" role="tablist">
            <li class="nav-item">
              <button class="btn btn-link nav-link active All py-3" data-bs-toggle="tab" id="All" role="tab" aria-selected="true" onClick="filterOrders('All')">
                <i class="ri-store-2-fill me-1 align-bottom"></i> All Orders
              </button>
            </li>
            <li class="nav-item">
              <button class="btn btn-link nav-link py-3 Delivered" data-bs-toggle="tab" id="Delivered" role="tab" aria-selected="false" onClick="filterOrders('Deliver')">
                <i class="ri-checkbox-circle-line me-1 align-bottom"></i> Delivered
              </button>
            </li>
            <li class="nav-item">
              <button class="btn btn-link nav-link py-3 Returns" data-bs-toggle="tab" id="Returns" role="tab" aria-selected="false" onClick="filterOrders('Return')">
                <i class="ri-arrow-left-right-fill me-1 align-bottom"></i> Returns
              </button>
            </li>
            <li class="nav-item">
              <button class="btn btn-link nav-link py-3 CashCollection" data-bs-toggle="tab" id="CashCollection" role="tab" aria-selected="false" onClick="filterOrders('Exchange')">
                <i class="ri-exchange-line me-1 align-bottom"></i> Exchange
              </button>
            </li>

            <li class="nav-item">
              <button class="btn btn-link nav-link py-3 CashCollection" data-bs-toggle="tab" id="CashCollection" role="tab" aria-selected="false" onClick="filterOrders('CashCollection')">
                <i class="ri-money-dollar-circle-line me-1 align-bottom"></i> Cash Collection
              </button>
            </li>
            <li class="nav-item">
              <button class="btn btn-link nav-link py-3 Returned" data-bs-toggle="tab" id="Returned" role="tab" aria-selected="false" onClick="filterReturnedOrders()">
                <i class="ri-arrow-left-circle-line me-1 align-bottom"></i> Returned Orders
              </button>
            </li>

          </ul>

          <div class="table-responsive table-card mb-1">
            <table class="table table-nowrap align-middle" id="orderTable">
              <thead class="text-muted table-light">
                <tr class="text-uppercase">
                  <th scope="col" style="width: 25px;">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="checkAll" value="option">
                    </div>
                  </th>
                  <th  data-sort="id">Order ID</th>
                  <th  data-sort="customer_name">Customer</th>
                  <th  data-sort="order-type">Order Type</th>
                  <th  data-sort="order-Location">Order Location</th>
                  <th  data-sort="amount">Amount</th>
                  <th  data-sort="status">Delivery Status</th>
                  <th  data-sort="status">Delivery Tries</th>
                  <th  data-sort="date">Order Date</th>
                  <th data-sort="city">Action</th>
                </tr>
              </thead>
           <tbody class="list form-check-all" id="ordersTable">
             <!-- Orders will be inserted here dynamically -->
           </tbody>
            </table>


            <div class="noresult" id="NoResult" style="display: none">
              <div class="text-center">
                <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#405189,secondary:#0ab39c" style="width:75px;height:75px"></lord-icon>
                <h5 class="mt-2">Sorry! No Result Found</h5>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end">
          <div class="pagination-wrap hstack gap-2">
            <a class="page-item pagination-prev disabled" href="javascript:void(0);">
              Previous
            </a>
            <ul class="pagination listjs-pagination mb-0"></ul>
            <a class="page-item pagination-next" href="javascript:void(0);">
              Next
            </a>
          </div>
        </div>
      </div>



      <!-- Print Policy Modal -->
    <div class="modal fade" id="printPolicyModal" tabindex="-1" aria-labelledby="printPolicyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-gradient-primary text-white border-0">
            <div class="d-flex align-items-center">
              <div class="print-icon-wrapper me-3">
                <i class="ri-printer-fill print-icon"></i>
              </div>
              <div>
                <h4 class="modal-title mb-0 fw-semibold" id="printPolicyModalLabel">Print Delivery Policy</h4>
                <small class="text-white-50">Select paper size and format</small>
              </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="print-info-section mb-4">
              <div class="alert alert-info border-0 bg-light-info">
                <div class="d-flex align-items-center">
                  <i class="ri-information-line text-info me-2"></i>
                  <div>
                    <h6 class="alert-heading mb-1">Print Delivery Policy</h6>
                    <p class="mb-0 small">Select the appropriate paper size for printing the delivery policy document.</p>
                  </div>
                </div>
              </div>
            </div>
            
            <form id="printPolicyForm">
              <input type="hidden" id="orderId" name="orderId" value="">
              
              <div class="paper-selection-section">
                <h6 class="fw-semibold text-dark mb-3">
                  <i class="ri-file-copy-line text-primary me-2"></i>Select Paper Size
                </h6>
                
                <div class="row g-3 justify-content-center">
                  <div class="col-md-5 col-lg-4">
                    <div class="paper-size-card" onclick="selectPaperSize('A4')">
                      <div class="paper-icon-container">
                        <i class="ri-file-text-line paper-icon"></i>
                      </div>
                      <div class="paper-info">
                        <h6 class="paper-label">A4</h6>
                        <p class="paper-dimensions">210 × 297 mm</p>
                        <small class="paper-description">Standard size</small>
                      </div>
                      <div class="selection-indicator">
                        <i class="ri-check-line"></i>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-5 col-lg-4">
                    <div class="paper-size-card" onclick="selectPaperSize('A5')">
                      <div class="paper-icon-container">
                        <i class="ri-file-reduce-line paper-icon"></i>
                      </div>
                      <div class="paper-info">
                        <h6 class="paper-label">A5</h6>
                        <p class="paper-dimensions">148 × 210 mm</p>
                        <small class="paper-description">Compact size</small>
                      </div>
                      <div class="selection-indicator">
                        <i class="ri-check-line"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <input type="hidden" id="paperSize" name="paperSize" value="">
            </form>
          </div>
          <div class="modal-footer bg-light border-0 p-4">
            <div class="d-flex justify-content-between w-100">
              <button type="button" class="btn btn-light border" data-bs-dismiss="modal">
                <i class="ri-close-line me-1"></i>Cancel
              </button>
              <button type="button" class="btn btn-primary" onclick="printPolicy()" id="printBtn" disabled>
                <i class="ri-printer-fill me-1"></i>Print Policy
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Sticker Scan Modal -->
    <div class="modal fade" id="smartStickerModal" tabindex="-1" aria-labelledby="smartStickerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-gradient-primary text-white border-0">
            <div class="d-flex align-items-center">
              <div class="scan-icon-wrapper me-3">
                <i class="ri-smartphone-line scan-icon"></i>
              </div>
              <div>
                <h4 class="modal-title mb-0 fw-semibold" id="smartStickerModalLabel">Smart Sticker Scan</h4>
                <small class="text-white-50">Mobile Application Feature</small>
              </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-4">
              <div class="col-lg-6">
                <div class="feature-card h-100">
                  <div class="text-center mb-4">
                    <div class="scan-animation mb-3">
                      <div class="scan-circle">
                        <i class="ri-qr-scan-line"></i>
                      </div>
                    </div>
                    <h5 class="text-dark fw-semibold mb-2">Mobile App Feature</h5>
                    <p class="text-muted mb-0">Smart Sticker Scan is available in our mobile application for iOS and Android devices.</p>
                  </div>
                  
                  <div class="features-section">
                    <h6 class="fw-semibold text-dark mb-3">
                      <i class="ri-star-fill text-warning me-2"></i>Key Features
                    </h6>
                    <div class="feature-list">
                      <div class="feature-item">
                        <div class="feature-icon bg-success-subtle">
                          <i class="ri-flashlight-line text-success"></i>
                        </div>
                        <div class="feature-text">
                          <h6 class="mb-1 fw-medium">Quick Scanning</h6>
                          <p class="text-muted mb-0 small">Instant order identification</p>
                        </div>
                      </div>
                      <div class="feature-item">
                        <div class="feature-icon bg-primary-subtle">
                          <i class="ri-refresh-line text-primary"></i>
                        </div>
                        <div class="feature-text">
                          <h6 class="mb-1 fw-medium">Real-time Updates</h6>
                          <p class="text-muted mb-0 small">Live status synchronization</p>
                        </div>
                      </div>
                  
                      <div class="feature-item">
                        <div class="feature-icon bg-info-subtle">
                          <i class="ri-notification-3-line text-info"></i>
                        </div>
                        <div class="feature-text">
                          <h6 class="mb-1 fw-medium">Push Notifications</h6>
                          <p class="text-muted mb-0 small">Instant alerts and updates</p>
                        </div>
                      </div>
               
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-6">
                <div class="download-card h-100">
                  <div class="download-section mb-4">
                    <h6 class="fw-semibold text-dark mb-3">
                      <i class="ri-download-line text-primary me-2"></i>Download Mobile App
                    </h6>
                    
                    <div class="d-grid gap-3 mb-4">
                      <button class="btn btn-dark btn-lg download-btn" onclick="downloadApp('ios')">
                        <i class="ri-apple-line me-2"></i>
                        <div class="download-text">
                          <div class="download-label">Download for</div>
                          <div class="download-platform">iOS</div>
                        </div>
                      </button>
                      <button class="btn btn-success btn-lg download-btn" onclick="downloadApp('android')">
                        <i class="ri-android-line me-2"></i>
                        <div class="download-text">
                          <div class="download-label">Download for</div>
                          <div class="download-platform">Android</div>
                        </div>
                      </button>
                    </div>
                  </div>
                  
                  <div class="how-to-use-section">
                    <h6 class="fw-semibold text-dark mb-3">
                      <i class="ri-guide-line text-primary me-2"></i>How to Use Smart Scan
                    </h6>
                    <div class="steps-container">
                      <div class="step-item">
                        <div class="step-indicator">
                          <span class="step-number">1</span>
                        </div>
                        <div class="step-content">
                          <h6 class="step-title">Open the App</h6>
                          <p class="step-description">Launch the mobile app and login to your account</p>
                        </div>
                      </div>
                      <div class="step-item">
                        <div class="step-indicator">
                          <span class="step-number">2</span>
                        </div>
                        <div class="step-content">
                          <h6 class="step-title">Navigate to Orders</h6>
                          <p class="step-description">Go to the Orders section from the main menu</p>
                        </div>
                      </div>
                      <div class="step-item">
                        <div class="step-indicator">
                          <span class="step-number">3</span>
                        </div>
                        <div class="step-content">
                          <h6 class="step-title">Tap Scan Icon</h6>
                          <p class="step-description">Tap the scan icon in the top right corner</p>
                        </div>
                      </div>
                      <div class="step-item">
                        <div class="step-indicator">
                          <span class="step-number">4</span>
                        </div>
                        <div class="step-content">
                          <h6 class="step-title">Point Camera</h6>
                          <p class="step-description">Point your camera at the sticker and wait for scan</p>
                        </div>
                      </div>
                      <div class="step-item">
                        <div class="step-indicator">
                          <span class="step-number">5</span>
                        </div>
                        <div class="step-content">
                          <h6 class="step-title">View Details</h6>
                          <p class="step-description">View order details and update status instantly</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-light border-0 p-4">
            <div class="d-flex justify-content-between w-100">
              <button type="button" class="btn btn-light border" data-bs-dismiss="modal">
                <i class="ri-close-line me-1"></i>Close
              </button>
              <button type="button" class="btn btn-primary" onclick="showQRCode()">
                <i class="ri-qr-code-line me-1"></i>Show QR Code
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    </div>
  </div>

</div>
<!--end col-->
</div>
<!--end row-->

<%- contentFor('FooterJs') %>


<!-- list.js min js -->
<script src="/assets/libs/list.js/list.min.js"></script>

<!--list pagination js-->
<script src="/assets/libs/list.pagination.js/list.pagination.min.js"></script>

<!-- ecommerce-order init js -->
<!-- <script src="/assets/js/pages/ecommerce-order.init.js"></script> -->

<script src="/assets/libs/sweetalert2/sweetalert2.min.js"></script>

<!-- Status helper -->
<script src="/assets/js/status-helper.js"></script>

<script src="/assets/rJS/business/orders.js"></script>

<script>
  // Function to select paper size
  function selectPaperSize(size) {
    // Remove selected class from all options
    document.querySelectorAll('.paper-size-card').forEach(card => {
      card.classList.remove('selected');
    });

    // Add selected class to clicked option
    const selectedCard = document.querySelector(`.paper-size-card[onclick="selectPaperSize('${size}')"]`);
    if (selectedCard) {
      selectedCard.classList.add('selected');
    }

    // Set the hidden input value
    document.getElementById('paperSize').value = size;
    
    // Enable print button
    const printBtn = document.getElementById('printBtn');
    if (printBtn) {
      printBtn.disabled = false;
    }
  }

  // Function to set order ID
  function setOrderId(id) {
    document.getElementById('orderId').value = id;
  }

  // Function to print policy
  function printPolicy() {
    const orderId = document.getElementById('orderId').value;
    const paperSize = document.getElementById('paperSize').value;

    if (!paperSize) {
      Swal.fire({
        icon: 'warning',
        title: 'Paper Size Required',
        text: 'Please select a paper size before printing.',
        confirmButtonColor: '#0d6efd'
      });
      return;
    }

    // Show loading indicator
    Swal.fire({
      title: 'Preparing document...',
      html: 'Please wait while we prepare your document.',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Send request to print policy
    fetch(`/business/print-policy/${orderId}?paperSize=${paperSize}`, {
        method: 'GET',
      })
      .then(async response => {
        if (!response.ok) {
          // Try to parse error message from JSON response
          try {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to generate document');
          } catch (e) {
            throw new Error('Failed to generate document');
          }
        }
        return response.blob();
      })
      .then(blob => {
        // Create URL for the blob
        const url = window.URL.createObjectURL(blob);

        // Create a link and click it to download the file
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `delivery-policy-${orderId}.pdf`;
        document.body.appendChild(a);
        a.click();

        // Clean up
        window.URL.revokeObjectURL(url);

        // Close modal using Bootstrap 5 vanilla JS API
        const modalElement = document.getElementById('printPolicyModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
          modalInstance.hide();
        }

        // Show success message
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Delivery policy has been prepared for printing.',
          confirmButtonColor: '#0d6efd'
        });
      })
      .catch(error => {
        console.error('Error:', error);
        
        // Close modal on error too
        const modalElement = document.getElementById('printPolicyModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
          modalInstance.hide();
        }
        
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: error.message || 'Something went wrong while preparing the document.',
          confirmButtonColor: '#0d6efd'
        });
      });
  }

  // Filter returned orders
  function filterReturnedOrders() {
    const returnedOrders = allOrders.filter(order => 
      order.orderStatus === 'returned' || order.orderStatus === 'returnLinked'
    );
    populateOrdersTable(returnedOrders);
    updatePagination(returnedOrders);
  }

  // Download App Functions
  function downloadApp(platform) {
    if (platform === 'ios') {
      // Replace with your actual iOS App Store link
      window.open('https://apps.apple.com/app/your-app-name', '_blank');
    } else if (platform === 'android') {
      // Replace with your actual Google Play Store link
      window.open('https://play.google.com/store/apps/details?id=com.yourcompany.yourapp', '_blank');
    }
  }

  // Show QR Code Function
  function showQRCode() {
    Swal.fire({
      title: 'Download Mobile App',
      text: 'Scan this QR code with your mobile device to download the app',
      imageUrl: '/assets/images/qr-code-app-download.png', // Replace with your actual QR code image
      imageWidth: 200,
      imageHeight: 200,
      imageAlt: 'QR Code for App Download',
      confirmButtonText: 'Close',
      confirmButtonColor: '#0d6efd'
    });
  }

  // ============= BULK ACTIONS FUNCTIONALITY =============
  
  let selectedOrders = new Set();

  // Initialize checkbox listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Select All checkbox
    const checkAllBox = document.getElementById('checkAll');
    if (checkAllBox) {
      checkAllBox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="checkAll[]"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          if (this.checked) {
            selectedOrders.add(checkbox.value);
          } else {
            selectedOrders.delete(checkbox.value);
          }
        });
        updateBulkActionsToolbar();
      });
    }

    // Delegate event for individual checkboxes (since they're dynamically created)
    document.getElementById('orderTable')?.addEventListener('change', function(e) {
      if (e.target.matches('input[name="checkAll[]"]')) {
        const orderNumber = e.target.value;
        if (e.target.checked) {
          selectedOrders.add(orderNumber);
        } else {
          selectedOrders.delete(orderNumber);
          document.getElementById('checkAll').checked = false;
        }
        updateBulkActionsToolbar();
      }
    });
  });

  function updateBulkActionsToolbar() {
    const toolbar = document.getElementById('bulkActionsToolbar');
    const countSpan = document.getElementById('selectedCount');
    
    if (selectedOrders.size > 0) {
      toolbar.style.display = 'block';
      countSpan.textContent = selectedOrders.size;
    } else {
      toolbar.style.display = 'none';
    }
  }

  function clearSelection() {
    selectedOrders.clear();
    document.querySelectorAll('input[name="checkAll[]"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.getElementById('checkAll').checked = false;
    updateBulkActionsToolbar();
  }

  function bulkPrintPolicy() {
    if (selectedOrders.size === 0) {
      Swal.fire({
        icon: 'warning',
        title: 'No Orders Selected',
        text: 'Please select at least one order to print policies.',
        confirmButtonColor: '#0d6efd'
      });
      return;
    }

    // Show paper size selection modal for bulk print
    Swal.fire({
      title: 'Select Paper Size',
      html: `
        <div class="text-start">
          <p class="mb-3">Select paper size for <strong>${selectedOrders.size}</strong> delivery policies:</p>
          <div class="d-flex gap-3 justify-content-center">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="bulkPaperSize" id="bulkA4" value="A4" checked>
              <label class="form-check-label" for="bulkA4">
                <strong>A4</strong><br>
                <small class="text-muted">210 × 297 mm</small>
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="bulkPaperSize" id="bulkA5" value="A5">
              <label class="form-check-label" for="bulkA5">
                <strong>A5</strong><br>
                <small class="text-muted">148 × 210 mm</small>
              </label>
            </div>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Print Policies',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#0d6efd',
      preConfirm: () => {
        const selectedSize = document.querySelector('input[name="bulkPaperSize"]:checked');
        return selectedSize ? selectedSize.value : null;
      }
    }).then((result) => {
      if (result.isConfirmed && result.value) {
        processBulkPrint(Array.from(selectedOrders), result.value);
      }
    });
  }

  async function processBulkPrint(orderNumbers, paperSize) {
    let successCount = 0;
    let failCount = 0;
    const totalOrders = orderNumbers.length;

    Swal.fire({
      title: 'Processing...',
      html: `Printing policies: <strong>0</strong> / ${totalOrders}`,
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    for (let i = 0; i < orderNumbers.length; i++) {
      try {
        const response = await fetch(`/business/print-policy/${orderNumbers[i]}?paperSize=${paperSize}`, {
          method: 'GET',
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `delivery-policy-${orderNumbers[i]}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          successCount++;
        } else {
          failCount++;
        }

        // Update progress
        Swal.update({
          html: `Printing policies: <strong>${i + 1}</strong> / ${totalOrders}`
        });

        // Small delay between downloads to prevent browser blocking
        await new Promise(resolve => setTimeout(resolve, 500));
      } catch (error) {
        console.error('Error printing policy:', error);
        failCount++;
      }
    }

    // Clear selection after bulk print
    clearSelection();

    // Show result
    Swal.fire({
      icon: successCount > 0 ? 'success' : 'error',
      title: 'Bulk Print Complete',
      html: `
        <p><strong>${successCount}</strong> policies printed successfully</p>
        ${failCount > 0 ? `<p class="text-danger"><strong>${failCount}</strong> failed</p>` : ''}
      `,
      confirmButtonColor: '#0d6efd'
    });
  }

</script>

<script>
  (function initDatePicker(){
    function init() {
      var el = document.getElementById('demo-datepicker');
      if (!el) return;
      try {
        flatpickr(el, {
          mode: 'range',
          dateFormat: 'd M, Y',
          allowInput: true
        });
        // Open on focus for better UX
        el.addEventListener('focus', function(){ if (el._flatpickr) { el._flatpickr.open(); } });
      } catch (e) {
        console.error('Flatpickr init error:', e);
      }
    }
    if (typeof window.flatpickr === 'undefined') {
      var s = document.createElement('script');
      s.src = '/assets/libs/flatpickr/flatpickr.min.js';
      s.onload = init;
      document.head.appendChild(s);
    } else {
      init();
    }
  })();
</script>
