<%- contentFor('HeaderCss') %>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<link rel="stylesheet" href="/assets/css/area-selection-modal.css">

<style>
  :root {
    --primary-color: #F39720;
    --primary-hover: #e08a18;
    --primary-light: #fef4e8;
    --text-dark: #333333;
    --text-medium: #555555;
    --text-light: #777777;
    --border-color: #e0e0e0;
    --success-color: #28a745;
    --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  body {
    font-family: 'Poppins', sans-serif;
    color: var(--text-dark);
  }

  /* Card Styling */
  .card {
    border: none;
    border-radius: 16px !important;
    box-shadow: var(--card-shadow);
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .card-header {
    background-color: #ffffff;
    border-bottom: 1px solid var(--border-color);
    padding: 1.25rem;
    font-weight: 600;
  }

  .card-body {
    padding: 1.5rem;
  }

  /* Form Elements */
  .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-medium);
  }

  .form-control,
  .form-select {
    border-radius: 10px;
    border: 1px solid var(--border-color);
    padding: 0.65rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(243, 151, 32, 0.15);
  }

  .input-group {
    border-radius: 10px;
    overflow: hidden;
  }

  .input-group .btn {
    border-radius: 0;
    background-color: #f8f9fa;
    color: var(--text-medium);
    border: 1px solid var(--border-color);
    font-weight: 500;
  }

  .input-group .btn:hover {
    background-color: #e9ecef;
  }

  /* Navigation Pills */
  .nav-pills .nav-link {
    border-radius: 12px;
    padding: 1rem 1.5rem;
    font-weight: 500;
    color: var(--text-medium);
    transition: all 0.3s ease;
  }

  .nav-pills .nav-link.active {
    background-color: var(--primary-color);
    color: white;
  }

  .nav-pills .nav-link:hover:not(.active) {
    background-color: var(--primary-light);
    color: var(--primary-color);
  }

  .nav-pills .nav-link i {
    /* background-color: rgba(243, 151, 32, 0.15) !important; */
    color: var(--primary-color) !important;
  }
  .step-arrow-nav .nav .nav-link.active::before {
      background-color: none !important;
  }
  .step-arrow-nav .nav .nav-link::before{
        content: none !important;
        position: none !important;
        border: none !important;
        right: none !important;
        top: none !important;
        transform: none !important;
  }

  /* Buttons */
  .btn-primary {
    background-color: var(--primary-color);
    border: none;
    border-radius: 10px;
    padding: 0.65rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    background-color: var(--primary-hover);
    transform: translateY(-2px);
  }

  .btn-light {
    background-color: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 0.65rem 1.5rem;
    font-weight: 500;
    color: var(--text-medium);
    transition: all 0.3s ease;
  }

  .btn-light:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }

  /* Order Type Cards */
  .form-check.card-radio {
    padding: 0;
    margin-bottom: 0.5rem;
  }

  .form-check.card-radio .form-check-input {
    display: none;
  }

  .form-check.card-radio .form-check-label {
    display: block;
    padding: 1.25rem;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .form-check.card-radio .form-check-input:checked+.form-check-label {
    border-color: var(--primary-color);
    background-color: var(--primary-light);
    box-shadow: 0 0 0 1px var(--primary-color);
  }

  .form-check.card-radio .form-check-label:hover {
    background-color: var(--primary-light);
  }

  .form-check.card-radio .form-check-label i {
    color: var(--primary-color);
    font-size: 1.25rem;
  }

  /* Hover Effects */
  .hover-effect:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  /* Section Headers */
  .section-title {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
  }

  .section-subtitle {
    color: var(--text-light);
    margin-bottom: 1.5rem;
  }

  /* Fee Display */
  .fee-display {
    background-color: var(--primary-light);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    position: relative;
  }

  .fee-amount {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
  }

  .fee-currency {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-medium);
  }

  .fee-label {
    color: var(--text-light);
    font-size: 0.9rem;
  }
  
  /* Loading styles */
  .loading-spinner {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .loading .loading-spinner {
    display: block;
  }
  
  .loading .fee-amount,
  .loading .fee-currency {
    opacity: 0.3;
  }

  /* Completion Screen */
  .completion-icon {
    width: 120px;
    height: 120px;
    margin: 0 auto 1.5rem;
  }

  .completion-title {
    font-weight: 600;
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .completion-message {
    color: var(--text-light);
    margin-bottom: 1.5rem;
  }

  .order-id {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .order-id a {
    color: var(--primary-color);
    text-decoration: underline;
  }

  /* Custom Select Styling */
  .select-container {
    position: relative;
  }

  .select-container select {
    appearance: none;
    -webkit-appearance: none;
    padding-right: 2.5rem;
  }

  .zone-select-wrapper {
    position: relative;
  }

  .zone-select-arrow {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
  }

  .zone-select-arrow i {
    color: var(--text-medium);
  }

  /* Loading styles for fee display */
  .fee-display {
    position: relative;
  }

  .loading-spinner {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .loading .loading-spinner {
    display: block;
  }

  .loading .fee-amount,
  .loading .fee-currency {
    opacity: 0.3;
  }

  /* Additional styles specific to create-order page if needed */
</style>

<%- contentFor('body') %>
<div class="row justify-content-center">
  <div class="col-xl-11">
    <div class="card">
      <div class="card-body checkout-tab">
        <form id="createOrderForm">
          <!-- Step Navigation -->
          <div class="step-arrow-nav mt-n3 mx-n3 mb-4">
            <ul class="nav nav-pills nav-justified custom-nav" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link nav-create fs-15 p-3 active" id="pills-bill-info-tab" data-bs-toggle="pill" data-bs-target="#pills-bill-info" type="button" role="tab" aria-controls="pills-bill-info" aria-selected="true">
                  <i class="ri-user-2-line fs-16 p-2 rounded-circle align-middle me-2"></i> Customer Details
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link nav-create fs-15 p-3" id="pills-bill-address-tab" data-bs-toggle="pill" data-bs-target="#pills-bill-address" type="button" role="tab" aria-controls="pills-bill-address" aria-selected="false">
                  <i class="ri-truck-line fs-16 p-2 rounded-circle align-middle me-2"></i> Shipping Details
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link nav-create fs-15 p-3" id="pills-payment-tab" data-bs-toggle="pill" data-bs-target="#pills-payment" type="button" role="tab" aria-controls="pills-payment" aria-selected="false">
                  <i class="ri-bank-card-line fs-16 p-2 rounded-circle align-middle me-2"></i> Additional Options
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link nav-create fs-15 p-3 disabled" id="pills-finish-tab" data-bs-toggle="pill" data-bs-target="#pills-finish" type="button" role="tab" aria-controls="pills-finish" aria-selected="false" tabindex="-1"></button>
                  <i class="ri-checkbox-circle-line fs-16 p-2 rounded-circle align-middle me-2"></i> Complete
                </button>
              </li>
            </ul>
          </div>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Customer Info Tab -->
            <div class="tab-pane fade show active" id="pills-bill-info" role="tabpanel" aria-labelledby="pills-bill-info-tab">
              <div class="mb-4">
                <h5 class="section-title">Customer Information</h5>
                <p class="section-subtitle">Enter the customer's contact details</p>
              </div>

              <!-- Customer Info Form -->
              <div>
                <div class="row g-4">
                  <div class="col-sm-6">
                    <div class="mb-3">
                      <label for="billinginfo-firstName" class="form-label">Full Name</label>
                      <input type="text" class="form-control" name="fullName" id="billinginfo-firstName" placeholder="Enter customer's full name">
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <div class="mb-3">
                      <label for="billinginfo-phoneNumber" class="form-label">Phone Number</label>
                      <input type="tel" class="form-control" name="phoneNumber" id="billinginfo-phoneNumber" placeholder="Enter phone number">
                    </div>
                  </div>
                </div>
                <div class="row g-3">
                  <div class="col-md-12">
                    <h5 class="section-title mb-3">Location Details</h5>
                  </div>

                  <div class="mb-3 col-md-12">
                    <label for="governorate-area" class="form-label">Governorate and Area</label>
                    <button type="button" class="btn btn-outline-secondary w-100 text-start" id="selectAreaBtn" style="height: 45px; display: flex; align-items: center; justify-content: space-between;">
                      <span id="selectedAreaDisplay">Select Area</span>
                      <i class="ri-arrow-down-s-line"></i>
                    </button>
                    <input type="hidden" name="government" id="government-value">
                    <input type="hidden" name="zone" id="zone-value">
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-md-12">
                    <label for="address" class="form-label">Address</label>
                    <textarea class="form-control" id="address" name="address" rows="3" placeholder="Enter full address"></textarea>
                  </div>
                </div>

                <div class="d-flex align-items-start gap-3 mt-4">
                  <button type="button" class="btn btn-primary btn-label right ms-auto nexttab" data-nexttab="pills-bill-address-tab">
                    <i class="ri-truck-line label-icon align-middle fs-16 ms-2"></i>Continue to Shipping
                  </button>
                </div>
              </div>
            </div>

            <!-- Shipping Info Tab -->
            <div class="tab-pane fade" id="pills-bill-address" role="tabpanel" aria-labelledby="pills-bill-address-tab">
              <div class="mb-4">
                <h5 class="section-title">Shipping Information</h5>
                <p class="section-subtitle">Select delivery type and provide shipping details</p>
              </div>

              <!-- Order Type Section -->
              <div class="card mb-4 hover-effect">
                <div class="card-header">
                  <h6 class="mb-0">Order Type</h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-lg-3 col-sm-6">
                      <div class="form-check card-radio">
                        <input id="paymentMethod01" name="orderType" type="radio" class="form-check-input" value="Deliver">
                        <label class="form-check-label" for="paymentMethod01">
                          <span class="fs-16 me-2"><i class="ri-truck-line align-bottom"></i></span>
                          <span class="fs-14 text-wrap">Deliver</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                      <div class="form-check card-radio">
                        <input id="paymentMethod02" name="orderType" type="radio" class="form-check-input" value="Exchange">
                        <label class="form-check-label" for="paymentMethod02">
                          <span class="fs-16 me-2"><i class="ri-exchange-line align-bottom"></i></span>
                          <span class="fs-14 text-wrap">Exchange</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                      <div class="form-check card-radio">
                        <input id="paymentMethod03" name="orderType" type="radio" class="form-check-input" value="Return">
                        <label class="form-check-label" for="paymentMethod03">
                          <span class="fs-16 me-2"><i class="ri-arrow-go-back-line align-bottom"></i></span>
                          <span class="fs-14 text-wrap">Return</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                      <div class="form-check card-radio">
                        <input id="paymentMethod04" name="orderType" type="radio" class="form-check-input" value="Cash Collection">
                        <label class="form-check-label" for="paymentMethod04">
                          <span class="fs-16 me-2"><i class="ri-money-dollar-circle-line align-bottom"></i></span>
                          <span class="fs-14 text-wrap">Cash Collection</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Deliver Section -->
              <div id="deliver-section" class="card mb-4 hover-effect" style="display: none;">
                <div class="card-header">
                  <h6 class="mb-0">Delivery Details</h6>
                </div>
                <div class="card-body">
                  <div class="mb-4">
                    <label for="delivery-description" class="form-label">Product Description</label>
                    <textarea class="form-control" name="productDescription" id="delivery-description" placeholder="Describe the products being delivered" rows="3"></textarea>
                  </div>
                  <div class="mb-4 col-md-4">
                    <label for="shipping-count" class="form-label">Number of Items</label>
                    <div class="input-group">
                      <button type="button" class="btn" id="decrement-shipping">-</button>
                      <input type="number" name="numberOfItems" class="form-control text-center" id="shipping-count" value="1" min="1">
                      <button type="button" class="btn" id="increment-shipping">+</button>
                    </div>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" name="isExpressShipping" type="checkbox" id="express-shipping-checkbox">
                    <label class="form-check-label" for="express-shipping-checkbox">
                      Express Shipping <i class="ri-information-line text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Same day delivery service. Doubles the shipping fee but ensures faster delivery."></i>
                    </label>
                  </div>
                  <div id="cash-on-delivery-section" style="display: none;">
                    <div class="form-check mb-3">
                      <input class="form-check-input" name="COD" type="checkbox" id="cash-on-delivery-checkbox">
                      <label class="form-check-label" for="cash-on-delivery-checkbox">
                        Cash on Delivery
                      </label>
                    </div>
                    <div class="mb-3" id="cash-on-delivery-amount" style="display: none;">
                      <label for="cash-on-delivery-input" class="form-label">Amount to Collect</label>
                      <div class="input-group">
                        <span class="input-group-text">EGP</span>
                        <input type="number" name="amountCOD" class="form-control" id="cash-on-delivery-input" placeholder="Enter amount">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Exchange Section -->
              <div id="exchange-section" class="card mb-4 hover-effect" style="display: none;">
                <div class="card-header">
                  <h6 class="mb-0">Exchange Details</h6>
                </div>
                <div class="card-body">
                  <div class="mb-4">
                    <label for="exchange-current-product" class="form-label">Current Product Description</label>
                    <textarea class="form-control" name="currentPD" id="exchange-current-product" placeholder="Describe the products being returned" rows="3"></textarea>
                  </div>
                  <div class="mb-4 col-md-4">
                    <label for="exchange-current-count" class="form-label">Number of Current Items</label>
                    <div class="input-group">
                      <button type="button" class="btn" id="decrement-current">-</button>
                      <input type="number" name="numberOfItemsCurrentPD" class="form-control text-center" id="exchange-current-count" value="1" min="1">
                      <button type="button" class="btn" id="increment-current">+</button>
                    </div>
                  </div>
                  <div class="mb-4">
                    <label for="exchange-new-product" class="form-label">New Product Description</label>
                    <textarea class="form-control" name="newPD" id="exchange-new-product" placeholder="Describe the replacement products" rows="3"></textarea>
                  </div>
                  <div class="mb-4 col-md-4">
                    <label for="exchange-new-count" class="form-label">Number of New Items</label>
                    <div class="input-group">
                      <button type="button" class="btn" id="decrement-new">-</button>
                      <input type="number" name="numberOfItemsNewPD" class="form-control text-center" id="exchange-new-count" value="1" min="1">
                      <button type="button" class="btn" id="increment-new">+</button>
                    </div>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" name="isExpressShipping" type="checkbox" id="express-shipping-exchange-checkbox">
                    <label class="form-check-label" for="express-shipping-exchange-checkbox">
                      Express Shipping <i class="ri-information-line text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Same day delivery service. Doubles the shipping fee but ensures faster delivery."></i>
                    </label>
                  </div>
                  <div id="cash-difference-section" style="display: none;">
                    <div class="form-check mb-3">
                      <input class="form-check-input" name="CashDifference" type="checkbox" id="cash-difference-checkbox">
                      <label class="form-check-label" for="cash-difference-checkbox">
                        Cash Difference
                      </label>
                    </div>
                    <div class="mb-3" id="cash-difference-amount" style="display: none;">
                      <label for="cash-difference-input" class="form-label">Difference Amount</label>
                      <div class="input-group">
                        <span class="input-group-text">EGP</span>
                        <input type="number" name="amountCashDifference" class="form-control" id="cash-difference-input" placeholder="Enter difference amount">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Return Section -->
              <div id="return-section" class="card mb-4 hover-effect" style="display: none;">
                <div class="card-header">
                  <h6 class="mb-0">Return Details</h6>
                </div>
                <div class="card-body">
                  <div class="alert alert-info mb-4">
                    <i class="ri-information-line me-2"></i>
                    <strong>Return Process:</strong> Create a return order for an existing delivered order. The original order will be automatically linked when the return is picked up.
                  </div>
                  
                  <div class="mb-4">
                    <label for="original-order-number" class="form-label">Original Order Number *</label>
                    <input type="text" class="form-control" name="originalOrderNumber" id="original-order-number" placeholder="Enter the order number of the delivered order to return" required>
                    <div class="form-text">
                      Enter the order number of the completed order that needs to be returned.
                    </div>
                    <div id="original-order-preview" class="alert alert-success mt-2" style="display: none;">
                      <h6>Original Order Found:</h6>
                      <div id="original-order-details"></div>
                    </div>
                  </div>

                  <!-- Partial Return Section -->
                  <div id="partial-return-section" class="card mb-4" style="display: none;">
                    <div class="card-header">
                      <h6 class="mb-0">Return Type Selection</h6>
                    </div>
                    <div class="card-body">
                      <div class="alert alert-info mb-3">
                        <i class="ri-information-line me-2"></i>
                        <strong>Multiple Items Detected:</strong> This order contains multiple items. Choose whether to return all items or just specific ones.
                      </div>
                      
                      <div class="mb-3">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="returnType" id="full-return" value="full" checked>
                          <label class="form-check-label" for="full-return">
                            <strong>Full Return</strong> - Return all items from the original order
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="returnType" id="partial-return" value="partial">
                          <label class="form-check-label" for="partial-return">
                            <strong>Partial Return</strong> - Return only specific items
                          </label>
                        </div>
                      </div>

                      <!-- Partial Return Details -->
                      <div id="partial-return-details" style="display: none;">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label for="partial-return-count" class="form-label">Number of Items to Return</label>
                            <div class="input-group">
                              <button type="button" class="btn" id="decrement-partial">-</button>
                              <input type="number" name="partialReturnItemCount" class="form-control text-center" id="partial-return-count" value="1" min="1">
                              <button type="button" class="btn" id="increment-partial">+</button>
                            </div>
                            <div class="form-text">Maximum: <span id="max-items"></span> items</div>
                          </div>
                          <div class="col-md-6">
                            <label for="remaining-count" class="form-label">Items Remaining with Customer</label>
                            <div class="form-control text-center" id="remaining-count" style="background-color: #f8f9fa;">0</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Standard Return Fields (hidden for partial returns) -->
                  <div id="standard-return-fields">
                    <div class="mb-4">
                      <label for="return-description" class="form-label">Product Description</label>
                      <textarea class="form-control" name="productDescription" id="return-description" placeholder="Describe the products being returned" rows="3"></textarea>
                    </div>
                    <div class="mb-4 col-md-4" id="standard-return-number-of-items">
                      <label for="return-count" class="form-label">Number of Items</label>
                      <div class="input-group">
                        <button type="button" class="btn" id="decrement-return">-</button>
                        <input type="number" name="numberOfItems" class="form-control text-center" id="return-count" value="1" min="1">
                        <button type="button" class="btn" id="increment-return">+</button>
                      </div>
                    </div>
                    <div class="mb-4">
                      <label for="return-reason" class="form-label">Return Reason *</label>
                      <select class="form-select" name="returnReason" id="return-reason" required>
                        <option value="">Select a reason</option>
                        <option value="Customer requested return">Customer requested return</option>
                        <option value="Damaged product">Damaged product</option>
                        <option value="Wrong product">Wrong product</option>
                        <option value="Quality issues">Quality issues</option>
                        <option value="Size/Color mismatch">Size/Color mismatch</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div class="mb-4">
                      <label for="return-notes" class="form-label">Return Notes</label>
                      <textarea class="form-control" name="returnNotes" id="return-notes" placeholder="Provide any additional details about the return..." rows="3"></textarea>
                    </div>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" name="isExpressShipping" type="checkbox" id="express-shipping-return-checkbox">
                    <label class="form-check-label" for="express-shipping-return-checkbox">
                      Express Return <i class="ri-information-line text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Same day return service. Doubles the shipping fee but ensures faster pickup."></i>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Cash Collection Section -->
              <div id="cash-collection-section" class="card mb-4 hover-effect" style="display: none;">
                <div class="card-header">
                  <h6 class="mb-0">Cash Collection Details</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="cash-collection-input" class="form-label">Amount to Collect</label>
                    <div class="input-group">
                      <span class="input-group-text">EGP</span>
                      <input type="number" name="amountCashCollection" class="form-control" id="cash-collection-input" placeholder="Enter amount to collect">
                    </div>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" name="isExpressShipping" type="checkbox" id="express-shipping-collection-checkbox">
                    <label class="form-check-label" for="express-shipping-collection-checkbox">
                      Express Collection <i class="ri-information-line text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Same day collection service. Doubles the shipping fee but ensures faster collection."></i>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="d-flex align-items-start gap-3 mt-4">
                <button type="button" class="btn btn-light btn-label previestab" data-previous="pills-bill-info-tab">
                  <i class="ri-arrow-left-line label-icon align-middle fs-16 me-2"></i>Back to Customer Details
                </button>
                <button type="button" class="btn btn-primary btn-label right ms-auto nexttab" data-nexttab="pills-payment-tab">
                  <i class="ri-bank-card-line label-icon align-middle fs-16 ms-2"></i>Continue to Additional Options
                </button>
              </div>
            </div>

            <!-- Extra Details Tab -->
            <div class="tab-pane fade" id="pills-payment" role="tabpanel" aria-labelledby="pills-payment-tab">
              <div class="mb-4">
                <h5 class="section-title">Additional Options</h5>
                <p class="section-subtitle">Specify any special requirements for this order</p>
              </div>

              <div class="card mb-4 hover-effect">
                <div class="card-body">
                  <div class="row g-4">
                    <div class="col-lg-4 col-md-6" id="orderCanbeOpened">
                      <div class="form-check card-radio">
                        <input class="form-check-input" name="previewPermission" type="checkbox" id="order-preview-checkbox">
                        <label class="form-check-label" for="order-preview-checkbox">
                          <span class="fs-16 me-2"><i class="ri-eye-line align-bottom"></i></span>
                          <span class="fs-14 text-wrap">Allow package inspection before delivery</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                      <div class="mb-3">
                        <label for="referral-number" class="form-label">Referral Number (Optional)</label>
                        <input type="text" name="referralNumber" class="form-control" id="referral-number" placeholder="Enter referral code if available">
                      </div>
                    </div>
                  </div>

                  <div class="mb-4">
                    <label for="delivery-notes" class="form-label">Special Instructions</label>
                    <textarea class="form-control" name="Notes" id="delivery-notes" placeholder="Add any special delivery instructions or notes" rows="3"></textarea>
                  </div>
                </div>
              </div>

              <!-- Fees Calculation Section -->
              <div class="card mb-4 hover-effect">
                <div class="card-header">
                  <h6 class="mb-0">Delivery Fee Summary</h6>
                </div>
                <div class="card-body">
                  <div class="fee-display" id="feeDisplayContainer">
                    <span class="fee-amount" id="totalFee">0</span>
                    <span class="fee-currency"> EGP</span>
                    <p class="fee-label mt-2">Total Delivery Fee</p>
                    <div class="loading-spinner">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex align-items-start gap-3 mt-4">
                <button type="button" class="btn btn-light btn-label previestab" data-previous="pills-bill-address-tab">
                  <i class="ri-arrow-left-line label-icon align-middle fs-16 me-2"></i>Back to Shipping
                </button>
                <button type="submit" id="completeOrderBTN" class="btn btn-primary btn-label right ms-auto">
                  <i class="ri-shopping-basket-line label-icon align-middle fs-16 ms-2"></i>Complete Order
                </button>
              </div>
            </div>

            <!-- Finish Tab -->
            <div class="tab-pane fade" id="pills-finish" role="tabpanel" aria-labelledby="pills-finish-tab">
              <div class="text-center py-5">
                <div class="mb-4">
                  <lord-icon src="https://cdn.lordicon.com/lupuorrc.json" trigger="loop" colors="primary:#F39720,secondary:#F39720" style="width:120px;height:120px"></lord-icon>
                </div>
                <h5 class="completion-title">Thank you! Your Order is Complete</h5>
                <p class="completion-message">A confirmation email with order details has been sent to the customer.</p>
                <h3 class="order-id">Order ID: <a href="apps-ecommerce-order-details" class="text-decoration-underline" id="orderNmber"></a></h3>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<%- contentFor('FooterJs') %>
<!-- Include Area Selection Modal -->
<%- include('../partials/area-selection-modal') %>

<!-- Hidden template for zone options -->
<script type="text/template" id="zone-options-template">
  <!-- Cairo zones -->
  <optgroup label="Cairo - Downtown & Central">
    <option value="Downtown">Downtown Cairo</option>
    <option value="Garden City">Garden City</option>
    <option value="Zamalek">Zamalek</option>
    <option value="Dokki">Dokki</option>
    <option value="Mohandessin">Mohandessin</option>
    <option value="Agouza">Agouza</option>
    <option value="Bulaq">Bulaq</option>
    <option value="Azbakeya">Azbakeya</option>
    <option value="Abdeen">Abdeen</option>
    <option value="Attaba">Attaba</option>
    <option value="Ramses">Ramses</option>
    <option value="Qasr El Nil">Qasr El Nil</option>
    <option value="Talaat Harb">Talaat Harb</option>
    <option value="Tahrir Square">Tahrir Square</option>
  </optgroup>
  <optgroup label="Cairo - East">
    <option value="Nasr City">Nasr City</option>
    <option value="Nasr City - First Zone">Nasr City - First Zone</option>
    <option value="Nasr City - Second Zone">Nasr City - Second Zone</option>
    <option value="Nasr City - Third Zone">Nasr City - Third Zone</option>
    <option value="Nasr City - Fourth Zone">Nasr City - Fourth Zone</option>
    <option value="Nasr City - Seventh Zone">Nasr City - Seventh Zone</option>
    <option value="Nasr City - Eighth Zone">Nasr City - Eighth Zone</option>
    <option value="Nasr City - Tenth Zone">Nasr City - Tenth Zone</option>
    <option value="Heliopolis">Heliopolis</option>
    <option value="Heliopolis - Korba">Heliopolis - Korba</option>
    <option value="Heliopolis - Triumph">Heliopolis - Triumph</option>
    <option value="Heliopolis - Cleopatra">Heliopolis - Cleopatra</option>
    <option value="Heliopolis - Almaza">Heliopolis - Almaza</option>
    <option value="Masr El Gedida">Masr El Gedida</option>
    <option value="El Nozha">El Nozha</option>
    <option value="El Nozha El Gedida">El Nozha El Gedida</option>
    <option value="El Zeitoun">El Zeitoun</option>
    <option value="Ain Shams">Ain Shams</option>
    <option value="Ain Shams - Ezbet El Nakhl">Ain Shams - Ezbet El Nakhl</option>
    <option value="El Marg">El Marg</option>
    <option value="El Marg El Gedida">El Marg El Gedida</option>
  </optgroup>
  <optgroup label="Cairo - South & New Cairo">
    <option value="Maadi">Maadi</option>
    <option value="New Cairo">New Cairo</option>
    <option value="Fifth Settlement">Fifth Settlement</option>
    <option value="First Settlement">First Settlement</option>
    <option value="Katameya">Katameya</option>
    <option value="El Mokattam">El Mokattam</option>
    <option value="El Basateen">El Basateen</option>
    <option value="Dar El Salam">Dar El Salam</option>
    <option value="El Rehab">El Rehab</option>
    <option value="El Tagamoa">El Tagamoa</option>
    <option value="El Shorouk">El Shorouk</option>
    <option value="Badr City">Badr City</option>
    <option value="Helwan">Helwan</option>
    <option value="15th of May City">15th of May City</option>
    <option value="Hadayek Helwan">Hadayek Helwan</option>
  </optgroup>
  <optgroup label="Cairo - West">
    <option value="Mohandessin">Mohandessin</option>
    <option value="Dokki">Dokki</option>
    <option value="Boulaq El Dakrour">Boulaq El Dakrour</option>
    <option value="Imbaba">Imbaba</option>
    <option value="Agouza">Agouza</option>
    <option value="Warraq">Warraq</option>
    <option value="Rod El Farag">Rod El Farag</option>
    <option value="Shobra">Shobra</option>
    <option value="Shobra El Kheima">Shobra El Kheima</option>
  </optgroup>
  
  <!-- Giza zones -->
  <optgroup label="Giza - Central & East">
    <option value="Giza Square">Giza Square</option>
    <option value="Dokki">Dokki</option>
    <option value="Mohandessin">Mohandessin</option>
    <option value="Agouza">Agouza</option>
    <option value="Haram">Haram</option>
    <option value="Faisal">Faisal</option>
    <option value="Imbaba">Imbaba</option>
    <option value="Kit Kat">Kit Kat</option>
    <option value="El Manial">El Manial</option>
    <option value="Boulaq El Dakrour">Boulaq El Dakrour</option>
    <option value="El Saff">El Saff</option>
    <option value="El Hawamdeya">El Hawamdeya</option>
  </optgroup>
  <optgroup label="Giza - West & 6th October">
    <option value="Sheikh Zayed">Sheikh Zayed</option>
    <option value="6th of October">6th of October</option>
    <option value="Hadayek Al Ahram">Hadayek Al Ahram</option>
    <option value="Al Wahat Road">Al Wahat Road</option>
    <option value="Smart Village">Smart Village</option>
    <option value="Egyptian Media Production City">Egyptian Media Production City</option>
  </optgroup>
  
  <!-- Alexandria zones -->
  <optgroup label="Alexandria - East">
    <option value="Sidi Gaber">Sidi Gaber</option>
    <option value="Sporting">Sporting</option>
    <option value="Camp Caesar">Camp Caesar</option>
    <option value="Smouha">Smouha</option>
    <option value="Victoria">Victoria</option>
    <option value="Bolkly">Bolkly</option>
    <option value="Ibrahimia">Ibrahimia</option>
    <option value="Laurent">Laurent</option>
    <option value="Loran">Loran</option>
  </optgroup>
  <optgroup label="Alexandria - Central & West">
    <option value="Bahary">Bahary</option>
    <option value="Anfushi">Anfushi</option>
    <option value="Manshiya">Manshiya</option>
    <option value="Attarin">Attarin</option>
    <option value="Gomrok">Gomrok</option>
    <option value="Karmouz">Karmouz</option>
    <option value="Moharam Bek">Moharam Bek</option>
    <option value="Dekhela">Dekhela</option>
    <option value="Agami">Agami</option>
    <option value="Amreya">Amreya</option>
    <option value="Borg El Arab">Borg El Arab</option>
    <option value="King Mariout">King Mariout</option>
    <option value="Wardian">Wardian</option>
    <option value="Bacos">Bacos</option>
  </optgroup>
  <optgroup label="Alexandria - East & Montaza">
    <option value="Sidi Bishr">Sidi Bishr</option>
    <option value="Miami">Miami</option>
    <option value="Asafra">Asafra</option>
    <option value="Mandara">Mandara</option>
    <option value="Montaza">Montaza</option>
    <option value="Abu Qir">Abu Qir</option>
    <option value="El Maamoura">El Maamoura</option>
    <option value="El Max">El Max</option>
    <option value="Aboukir">Aboukir</option>
    <option value="Semouha">Semouha</option>
    <option value="Fleming">Fleming</option>
    <option value="El Zahria">El Zahria</option>
    <option value="Gianaclis">Gianaclis</option>
  </optgroup>
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="/assets/js/area-selection-modal.js"></script>

<script>
// Enhanced order type handling with return section
document.addEventListener('DOMContentLoaded', function() {
  // Handle order type selection
  const orderTypeRadios = document.querySelectorAll('input[name="orderType"]');
  const deliverSection = document.getElementById('deliver-section');
  const exchangeSection = document.getElementById('exchange-section');
  const returnSection = document.getElementById('return-section');
  const cashCollectionSection = document.getElementById('cash-collection-section');

  // Utility to enable/disable a section's inputs so hidden sections don't block HTML5 validation
  function setSectionDisabled(sectionEl, shouldDisable) {
    if (!sectionEl) return;
    const fields = sectionEl.querySelectorAll('input, select, textarea, button');
    fields.forEach(function(field) {
      if (shouldDisable) {
        field.setAttribute('disabled', 'disabled');
        field.removeAttribute('required');
      } else {
        field.removeAttribute('disabled');
      }
    });
  }

  function hideAllSections() {
    // Hide
    deliverSection.style.display = 'none';
    exchangeSection.style.display = 'none';
    returnSection.style.display = 'none';
    cashCollectionSection.style.display = 'none';
    // Disable all so they don't trigger validation
    setSectionDisabled(deliverSection, true);
    setSectionDisabled(exchangeSection, true);
    setSectionDisabled(returnSection, true);
    setSectionDisabled(cashCollectionSection, true);
  }

  function activateDeliver() {
    deliverSection.style.display = 'block';
    setSectionDisabled(deliverSection, false);
  }

  function activateExchange() {
    exchangeSection.style.display = 'block';
    setSectionDisabled(exchangeSection, false);
  }

  function activateReturn() {
    returnSection.style.display = 'block';
    setSectionDisabled(returnSection, false);
    // Apply required attributes only for return-critical fields
    const originalOrderInput = document.querySelector('input[name="originalOrderNumber"]');
    const returnReasonSelect = document.querySelector('select[name="returnReason"]');
    if (originalOrderInput) originalOrderInput.setAttribute('required', 'required');
    if (returnReasonSelect) returnReasonSelect.setAttribute('required', 'required');
  }

  function activateCashCollection() {
    cashCollectionSection.style.display = 'block';
    setSectionDisabled(cashCollectionSection, false);
  }

  orderTypeRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      hideAllSections();
      // Show relevant section
      if (this.value === 'Deliver') {
        activateDeliver();
      } else if (this.value === 'Exchange') {
        activateExchange();
      } else if (this.value === 'Return') {
        activateReturn();
      } else if (this.value === 'Cash Collection') {
        activateCashCollection();
      }
    });
  });

  // On initial load, make sure hidden sections are disabled to avoid native validation errors
  hideAllSections();
  const initiallyChecked = Array.from(orderTypeRadios).find(r => r.checked);
  if (initiallyChecked) {
    if (initiallyChecked.value === 'Deliver') activateDeliver();
    else if (initiallyChecked.value === 'Exchange') activateExchange();
    else if (initiallyChecked.value === 'Return') activateReturn();
    else if (initiallyChecked.value === 'Cash Collection') activateCashCollection();
  }

  // Handle return order number validation
  const originalOrderInput = document.getElementById('original-order-number');
  const originalOrderPreview = document.getElementById('original-order-preview');
  const originalOrderDetails = document.getElementById('original-order-details');

  if (originalOrderInput) {
    originalOrderInput.addEventListener('input', async function() {
      const orderNumber = this.value.trim();
      
      if (orderNumber.length < 6) {
        originalOrderPreview.style.display = 'none';
        return;
      }

      try {
        const response = await fetch('/business/validate-original-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ orderNumber })
        });

        const data = await response.json();

        if (response.ok && data.order) {
          originalOrderDetails.innerHTML = `
            <div class="row">
              <div class="col-6"><strong>Order Number:</strong></div>
              <div class="col-6">${data.order.orderNumber}</div>
              <div class="col-6"><strong>Customer:</strong></div>
              <div class="col-6">${data.order.orderCustomer.fullName}</div>
              <div class="col-6"><strong>Status:</strong></div>
              <div class="col-6"><span class="badge bg-success">${data.order.orderStatus}</span></div>
              <div class="col-6"><strong>Product:</strong></div>
              <div class="col-6">${data.order.orderShipping.productDescription}</div>
              <div class="col-6"><strong>Items:</strong></div>
              <div class="col-6">${data.order.orderShipping.numberOfItems} item(s)</div>
            </div>
          `;
          originalOrderPreview.className = 'alert alert-success mt-2';
          originalOrderPreview.style.display = 'block';
          
          // Show partial return section if order has multiple items
          const partialReturnSection = document.getElementById('partial-return-section');
          if (data.order.hasMultipleItems) {
            partialReturnSection.style.display = 'block';
            document.getElementById('max-items').textContent = data.order.itemCount;
            
            // Set max value for partial return count
            const partialReturnCount = document.getElementById('partial-return-count');
            partialReturnCount.max = data.order.itemCount;
            
            // Update remaining count when partial return count changes
            updateRemainingCount();
          } else {
            partialReturnSection.style.display = 'none';
          }
        } else {
          originalOrderDetails.innerHTML = '<div class="text-danger">Order not found or not eligible for return.</div>';
          originalOrderPreview.className = 'alert alert-warning mt-2';
          originalOrderPreview.style.display = 'block';
        }
      } catch (error) {
        console.error('Error validating original order:', error);
        originalOrderDetails.innerHTML = '<div class="text-danger">Error validating order. Please try again.</div>';
        originalOrderPreview.className = 'alert alert-warning mt-2';
        originalOrderPreview.style.display = 'block';
      }
    });
  }

  // Handle return item count increment/decrement
  const decrementReturn = document.getElementById('decrement-return');
  const incrementReturn = document.getElementById('increment-return');
  const returnCount = document.getElementById('return-count');

  if (decrementReturn && incrementReturn && returnCount) {
    decrementReturn.addEventListener('click', function() {
      const currentValue = parseInt(returnCount.value);
      if (currentValue > 1) {
        returnCount.value = currentValue - 1;
      }
    });

    incrementReturn.addEventListener('click', function() {
      const currentValue = parseInt(returnCount.value);
      returnCount.value = currentValue + 1;
    });
  }

  // Handle partial return functionality
  const returnTypeRadios = document.querySelectorAll('input[name="returnType"]');
  const partialReturnDetails = document.getElementById('partial-return-details');
  const decrementPartial = document.getElementById('decrement-partial');
  const incrementPartial = document.getElementById('increment-partial');
  const partialReturnCount = document.getElementById('partial-return-count');

  // Function to update remaining count
  function updateRemainingCount() {
    const maxItems = parseInt(document.getElementById('max-items').textContent);
    const partialCount = parseInt(partialReturnCount.value);
    const remaining = maxItems - partialCount;
    document.getElementById('remaining-count').textContent = remaining;
  }

  // Handle return type selection
  if (returnTypeRadios.length > 0) {
    returnTypeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        const standardReturnFields = document.getElementById('standard-return-fields');
        
        if (this.value === 'partial') {
          partialReturnDetails.style.display = 'block';
          standardReturnFields.style.display = 'block';
          // Hide the standard Number of Items field for partial returns
          document.getElementById('standard-return-number-of-items').style.display = 'none';
          updateRemainingCount();
          
          // Keep required attributes on standard fields for partial returns
          document.getElementById('return-reason').setAttribute('required', 'required');
        } else {
          partialReturnDetails.style.display = 'none';
          standardReturnFields.style.display = 'block';
          // Show the standard Number of Items field for full returns
          document.getElementById('standard-return-number-of-items').style.display = 'block';
          
          // Keep required attributes on standard fields
          document.getElementById('return-reason').setAttribute('required', 'required');
        }
      });
    });
  }

  // Handle partial return count increment/decrement
  if (decrementPartial && incrementPartial && partialReturnCount) {
    decrementPartial.addEventListener('click', function() {
      const currentValue = parseInt(partialReturnCount.value);
      if (currentValue > 1) {
        partialReturnCount.value = currentValue - 1;
        updateRemainingCount();
      }
    });

    incrementPartial.addEventListener('click', function() {
      const maxItems = parseInt(document.getElementById('max-items').textContent);
      const currentValue = parseInt(partialReturnCount.value);
      if (currentValue < maxItems) {
        partialReturnCount.value = currentValue + 1;
        updateRemainingCount();
      }
    });

    // Handle manual input changes
    partialReturnCount.addEventListener('input', function() {
      const maxItems = parseInt(document.getElementById('max-items').textContent);
      const value = parseInt(this.value);
      
      if (value > maxItems) {
        this.value = maxItems;
      } else if (value < 1) {
        this.value = 1;
      }
      
      updateRemainingCount();
    });
  }
});
</script>

<script src="/assets/rJS/business/create-order.js"></script>

<!-- init js -->
<script src="/assets/js/pages/ecommerce-product-checkout.init.js"></script>
